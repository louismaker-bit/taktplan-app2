<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Taktplan</title>
  <style>
    /* iOS overscroll / background artifacts */
    html, body{
      height: 100%;
      overscroll-behavior: none;
    }

    :root{
      --bg: #0b0c10;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --border: rgba(255,255,255,.14);
      --accent: #7dd3fc;
      --ok: rgba(34,197,94,.16);
      --err: rgba(239,68,68,.18);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --pad: 14px;
      --tap: 48px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg: #f6f7fb;
        --card: rgba(255,255,255,.9);
        --card2: rgba(255,255,255,.96);
        --text: rgba(10,12,16,.92);
        --muted: rgba(10,12,16,.62);
        --border: rgba(10,12,16,.12);
        --accent: #0284c7;
        --ok: rgba(34,197,94,.14);
        --err: rgba(239,68,68,.12);
        --shadow: 0 10px 30px rgba(0,0,0,.10);
      }
    }

    body{
      margin: 0;
      font-family: var(--sans);
      /* FIX: remove green radial gradient; keep a subtle blue only */
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(125,211,252,.14), transparent 60%),
        var(--bg);
      background-attachment: fixed;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      padding-bottom: 28px;
    }

    body.force-dark{
      --bg:#0b0c10; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.62); --border:rgba(255,255,255,.14);
      --accent:#7dd3fc; --ok:rgba(34,197,94,.16); --err:rgba(239,68,68,.18); --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    body.force-light{
      --bg:#f6f7fb; --card:rgba(255,255,255,.92); --card2:rgba(255,255,255,.98);
      --text:rgba(10,12,16,.92); --muted:rgba(10,12,16,.62); --border:rgba(10,12,16,.12);
      --accent:#0284c7; --ok:rgba(34,197,94,.14); --err:rgba(239,68,68,.12); --shadow:0 10px 30px rgba(0,0,0,.10);
    }

    /* --------- Topbar (NOT fixed; scroll hides it) --------- */
    .topbar{
      padding: 12px 14px calc(12px + env(safe-area-inset-top));
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(0,0,0,.30), transparent);
      border-bottom: 1px solid var(--border);
    }
    .topbar-inner{
      max-width: 820px;
      margin: 0 auto;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap; /* iPhone 14 Pro portrait: wrap */
    }

    .title{ font-weight: 900; letter-spacing: .2px; }
    .sub{ font-size: 12px; color: var(--muted); margin-top: 2px; }
    .grow{ flex: 1; }

    .seg{
      display:flex; border: 1px solid var(--border); border-radius: 999px; overflow:hidden;
      background: var(--card);
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .seg button{
      height: 36px; min-width: 60px;
      border: 0; background: transparent; color: var(--muted);
      padding: 0 10px; font-weight: 800;
    }
    .seg button.active{ color: var(--text); background: rgba(125,211,252,.14); }

    .wrap{ max-width: 820px; margin: 0 auto; padding: 14px; }

    .card{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--pad);
      background: var(--card2);
      box-shadow: var(--shadow);
      margin-top: 12px;
    }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 540px){ .grid2{ grid-template-columns: 1fr; } }

    label{ display:block; font-weight: 900; margin: 10px 0 6px; color: var(--text); }

    textarea{
      width:100%; min-height: 130px; resize: vertical;
      border-radius: 14px; border: 1px solid var(--border);
      background: var(--card); color: var(--text);
      padding: 12px; font-size: 14px;
    }
    select, input{
      width: 100%;
      height: var(--tap);
      border-radius: 14px; border: 1px solid var(--border);
      background: var(--card); color: var(--text);
      padding: 0 12px; font-size: 16px;
    }

    button.btn{
      height: var(--tap);
      border-radius: 14px; border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      color: var(--text);
      font-weight: 900;
      width: 100%;
    }
    button.btn.primary{
      border-color: rgba(125,211,252,.35);
      background: linear-gradient(180deg, rgba(125,211,252,.22), rgba(125,211,252,.10));
    }
    button.btn:active{ transform: translateY(1px); }

    .small{ font-size: 12px; color: var(--muted); line-height: 1.35; }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px;
      background: var(--card); color: var(--muted); font-size: 12px;
      margin: 6px 6px 0 0;
    }

    .result.ok{ background: var(--ok); border-color: rgba(34,197,94,.35); }
    .result.err{ background: var(--err); border-color: rgba(239,68,68,.35); }
    .mono{ font-family: var(--mono); }

    .favbar{
      display:flex; flex-wrap: wrap; gap: 8px;
      margin-top: 8px;
    }
    .favbar button{
      height: 40px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-weight: 900;
    }
    .favbar button:active{ transform: translateY(1px); }

    .hide{ display:none !important; }

    /* Screenshot-friendly week table */
    table{ width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td{ border-bottom: 1px solid var(--border); padding: 8px 6px; text-align:left; font-size: 14px; }
    th{ color: var(--muted); font-weight: 900; }

    /* tighter week table on mobile so more fits on one screen */
    #week table th, #week table td{ padding: 6px 4px; font-size: 13px; }
    @media (max-width: 420px){
      #week table th, #week table td{ padding: 5px 3px; font-size: 12px; }
    }

    /* Compact mode */
    body.compact .small,
    body.compact .diagnostics,
    body.compact .storageCard,
    body.compact .planSaveCard { display:none !important; }
    body.compact textarea{ min-height: 96px; }

  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div>
        <div class="title">Taktplan</div>
        <div class="sub">Offline • Favoriten • Heute/Jetzt • Vergleich • Wochenübersicht</div>
      </div>
      <div class="grow"></div>

      <div class="seg" aria-label="Theme">
        <button id="themeAuto" class="active" type="button">Auto</button>
        <button id="themeDark" type="button">Dark</button>
        <button id="themeLight" type="button">Light</button>
      </div>

      <div class="seg" aria-label="Mode">
        <button id="modeFull" class="active" type="button">Full</button>
        <button id="modeCompact" type="button">Kompakt</button>
      </div>

      <div class="seg" aria-label="Haptik">
        <button id="haptOn" class="active" type="button">Haptik</button>
        <button id="haptOff" type="button">Aus</button>
      </div>
    </div>
  </div>

  <div class="wrap">

    <div class="card storageCard">
      <label>Gespeicherter Plan (aktiv)</label>
      <div class="grid2">
        <select id="planSelect"></select>
        <div class="grid2">
          <button class="btn" id="loadSaved" type="button">Laden</button>
          <button class="btn" id="deleteSaved" type="button">Löschen</button>
        </div>
      </div>
      <div class="small">Auto-Save überschreibt den aktiven Plan nach erfolgreichem „Plan anwenden“ (wenn aktiviert).</div>
    </div>

    <div class="card">
      <div class="grid2">
        <div>
          <label>Heute / Jetzt</label>
          <button class="btn primary" id="nowBtn" type="button">Heute + aktuelle Runde setzen</button>
          <div class="small" id="nowHint" style="margin-top:8px;"></div>
        </div>
        <div>
          <label>Schicht (für „Jetzt“)</label>
          <select id="shiftPreset">
            <option value="early">Früh (06:30–14:29)</option>
            <option value="late">Spät (14:30–22:29)</option>
            <option value="night">Nacht (22:30–06:10)</option>
          </select>
          <div class="small" style="margin-top:8px;">In Pausen wird automatisch die <strong>nächste</strong> Runde gesetzt.</div>
        </div>
      </div>

      <label>Plan einfügen (OCR oder Tabelle)</label>
      <textarea id="table" placeholder="OCR:
1 Airbag LISA 2 Bepl. Re. BESETZT ...

Tabelle:
1;Airbag;LISA"></textarea>

      <div class="grid2">
        <div>
          <label>Runden pro Tag</label>
          <input id="rounds" type="number" min="1" max="12" value="4" />
        </div>
        <div>
          <label>Auto-Apply</label>
          <select id="autoApply">
            <option value="on" selected>EIN</option>
            <option value="off">AUS</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Auto-Save (aktiver Plan)</label>
          <select id="autoSave">
            <option value="on" selected>EIN</option>
            <option value="off">AUS</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn" id="applyBtn" type="button">Plan anwenden (manuell)</button>
        </div>
      </div>

      <div class="diagnostics" id="diagPills"></div>
    </div>

    <div class="card">
      <div class="grid2">
        <div>
          <label>Mitarbeiter A</label>
          <select id="employee" disabled></select>
          <div class="favbar" id="favbar"></div>

          <label style="margin-top:12px;">Mitarbeiter B (Vergleich)</label>
          <select id="employee2" disabled></select>
        </div>

        <div>
          <label>Tag</label>
          <select id="day" disabled>
            <option value="mo">Mo</option><option value="di">Di</option><option value="mi">Mi</option>
            <option value="do">Do</option><option value="fr">Fr</option><option value="sa">Sa</option><option value="so">So</option>
          </select>

          <label>Runde</label>
          <select id="round" disabled></select>
        </div>
      </div>

      <div class="grid2">
        <button class="btn primary" id="queryBtn" type="button" disabled>Abfrage</button>
        <button class="btn" id="compareBtn" type="button" disabled>Vergleich</button>
      </div>

      <div class="grid2">
        <button class="btn" id="dayBtn" type="button" disabled>Tagesüberblick</button>
        <button class="btn" id="weekBtn" type="button" disabled>Wochenübersicht (Mo–Fr)</button>
      </div>

      <div class="grid2">
        <button class="btn" id="swapBtn" type="button" disabled>Tauschen</button>
        <button class="btn" id="clearBtn" type="button">Eingabe leeren</button>
      </div>


      <div class="grid2">
        <button class="btn" id="editFavBtn" type="button">Favoriten bearbeiten</button>
        <button class="btn" id="compareBtn" type="button" disabled>Vergleich</button>
      </div>


      <div class="small" style="margin-top:8px;">
        Tipp: Wenn „Vergleich“ aktiv ist, aktualisiert sich die Anzeige automatisch bei Änderungen (Tag/Runde/Mitarbeiter).
      </div>
    </div>

    <div id="result" class="card result hide"></div>
    <div id="week" class="card hide"></div>
    <div id="dayView" class="card hide"></div>


    <div class="card planSaveCard">
      <label>Plan speichern</label>
      <input id="planName" placeholder="z.B. Standardwoche / Änderung Mittwoch" />
      <div class="grid2" style="margin-top:10px;">
        <button class="btn" id="saveNew" type="button">Als neuen Plan speichern</button>
        <button class="btn" id="overwriteActive" type="button">Aktiven Plan überschreiben</button>
      </div>
      <div class="small">Tipp: Wenn sich mitten in der Woche was ändert, speichere eine zweite Version und lade sie bei Bedarf.</div>
    </div>

  </div>

<script>
  // ---------- constants ----------
  const DAY_ALIASES = { mo:0, di:1, mi:2, do:3, fr:4, sa:5, so:6 };
  const DAY_KEYS = ["mo","di","mi","do","fr","sa","so"];
  const DAY_NAMES = ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag","Sonntag"];

  // ---------- storage keys ----------
  const STORAGE_KEY = "taktplan_saved_v5";          // { plans: {id:{name,text,rounds,updatedAt}}, activeId }
  const LAST_DRAFT_KEY = "taktplan_last_draft_v5";  // { text, rounds, autoApply, autoSave, shiftPreset }
  const LAST_QUERY_KEY = "taktplan_last_query_v5";  // { employee, employee2, day, round, view }
  const UI_KEY = "taktplan_ui_v3";                  // { theme: auto|dark|light, mode: full|compact, haptics: on|off }
  const FAV_KEY = "taktplan_favs_v2";               // [ "LOUIS", "FLORIAN", ... ]

  // ---------- helpers ----------
  function normName(s){ return (s || "").trim().replace(/\s+/g," ").toUpperCase(); }
  function nowISO(){ return new Date().toISOString(); }
  function uid(){ return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

  function loadJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return fallback;
      return JSON.parse(raw);
    } catch { return fallback; }
  }
  function saveJSON(key, value){ localStorage.setItem(key, JSON.stringify(value)); }

  function loadState(){
    const s = loadJSON(STORAGE_KEY, { plans:{}, activeId:null });
    s.plans = s.plans || {};
    s.activeId = s.activeId || null;
    return s;
  }
  function saveState(state){ saveJSON(STORAGE_KEY, state); }

  function saveDraft(){
    saveJSON(LAST_DRAFT_KEY, {
      text: elTable.value,
      rounds: elRounds.value,
      autoApply: elAutoApply.value,
      autoSave: elAutoSave.value,
      shiftPreset: elShift.value
    });
  }
  function loadDraft(){ return loadJSON(LAST_DRAFT_KEY, null); }

  function saveLastQuery(){
    saveJSON(LAST_QUERY_KEY, {
      employee: elEmp.value,
      employee2: elEmp2.value,
      day: elDay.value,
      round: elRound.value,
      view: currentView
    });
  }
  function loadLastQuery(){ return loadJSON(LAST_QUERY_KEY, null); }

  // ---------- theme/mode/haptics ----------
  function setTheme(theme){
    const ui = loadJSON(UI_KEY, { theme:"auto", mode:"full", haptics:"on" });
    ui.theme = theme;
    saveJSON(UI_KEY, ui);

    document.body.classList.remove("force-dark","force-light");
    themeAuto.classList.toggle("active", theme==="auto");
    themeDark.classList.toggle("active", theme==="dark");
    themeLight.classList.toggle("active", theme==="light");

    if(theme==="dark") document.body.classList.add("force-dark");
    if(theme==="light") document.body.classList.add("force-light");
  }

  function setMode(mode){
    const ui = loadJSON(UI_KEY, { theme:"auto", mode:"full", haptics:"on" });
    ui.mode = mode;
    saveJSON(UI_KEY, ui);

    modeFull.classList.toggle("active", mode==="full");
    modeCompact.classList.toggle("active", mode==="compact");
    document.body.classList.toggle("compact", mode==="compact");
  }

  function setHaptics(v){
    const ui = loadJSON(UI_KEY, { theme:"auto", mode:"full", haptics:"on" });
    ui.haptics = v;
    saveJSON(UI_KEY, ui);

    haptOn.classList.toggle("active", v==="on");
    haptOff.classList.toggle("active", v==="off");
  }

  function canVibrate(){
    return typeof navigator !== "undefined" && "vibrate" in navigator;
  }

  function haptic(kind){
    const ui = loadJSON(UI_KEY, { theme:"auto", mode:"full", haptics:"on" });
    if(ui.haptics === "off") return;
    if(!canVibrate()) return;

    if(kind === "tap") navigator.vibrate(10);
    else if(kind === "ok") navigator.vibrate([12, 20, 12]);
    else if(kind === "warn") navigator.vibrate([18, 30, 18]);
    else if(kind === "err") navigator.vibrate([30, 40, 30]);
  }

  // Show helpers with optional haptics (so auto-update doesn't buzz)
  function showOk(html, doHaptic=true){
    if(doHaptic) haptic("ok");
    elResult.classList.remove("hide","err");
    elResult.classList.add("ok");
    elResult.innerHTML = html;
  }
  function showErr(msg, doHaptic=true){
    if(doHaptic) haptic("err");
    elResult.classList.remove("hide","ok");
    elResult.classList.add("err");
    elResult.innerHTML = `<div><strong>Fehler:</strong> ${msg}</div>`;
  }

  function hideWeek(){ elWeek.classList.add("hide"); elWeek.innerHTML=""; }
  function hideDay(){ elDayView.classList.add("hide"); elDayView.innerHTML=""; }

  function fillRounds(n){
    elRound.innerHTML = "";
    for(let i=1;i<=n;i++){
      const opt=document.createElement("option");
      opt.value=String(i); opt.textContent=String(i);
      elRound.appendChild(opt);
    }
  }
  function setEnabled(on){
    elEmp.disabled = !on;
    elEmp2.disabled = !on;
    elDay.disabled = !on;
    elDayBtn.disabled = !on;
    elRound.disabled = !on;
    elQuery.disabled = !on;
    elCompare.disabled = !on;
    elWeekBtn.disabled = !on;
    elSwap.disabled = !on;
  }

  // ---------- parsing (table + OCR single line) ----------
  function parseTable(text){
    const raw=(text||"").trim();
    if(!raw) return [];

    const looksLikeTable = /[;\t,]/.test(raw);

    if(looksLikeTable){
      const rows=[];
      const lines=raw.split(/\r?\n/);
      for(const line0 of lines){
        const line=line0.trim();
        if(!line) continue;
        const parts=line.split(/[\t;,]+/).map(x=>x.trim()).filter(Boolean);
        if(parts.length<3) continue;

        let takt=null, idx=null;
        for(let i=0;i<Math.min(2, parts.length);i++){
          if(/^\d+$/.test(parts[i])){ takt=parseInt(parts[i],10); idx=i; break; }
        }
        if(takt===null) continue;
        if(idx+2>=parts.length) continue;

        rows.push({ takt, bezeichnung: parts[idx+1], mitarbeiter: parts[idx+2] });
      }
      rows.sort((a,b)=>a.takt-b.takt);
      return rows;
    }

    const cleaned=raw.replace(/\r?\n/g," ").replace(/\s+/g," ").trim();
    const tokens=cleaned.split(" ").filter(Boolean);

    const segs=[];
    let i=0;
    while(i<tokens.length){
      if(!/^\d+$/.test(tokens[i])){ i++; continue; }
      const takt=parseInt(tokens[i],10); i++;
      const content=[];
      while(i<tokens.length && !/^\d+$/.test(tokens[i])){ content.push(tokens[i]); i++; }
      if(content.length>=2) segs.push({ takt, content });
    }

    const rows=segs.map(s=>{
      const mitarbeiter=s.content[s.content.length-1];
      const bezeichnung=s.content.slice(0,-1).join(" ").trim();
      return { takt: s.takt, bezeichnung, mitarbeiter };
    });
    rows.sort((a,b)=>a.takt-b.takt);
    return rows;
  }

  // ---------- plan logic ----------
  class TaktPlan{
    constructor(rows, roundsPerDay){
      if(!rows || rows.length===0) throw new Error("Keine gültigen Zeilen erkannt.");
      this.rows=rows;
      this.roundsPerDay=roundsPerDay;

      this.cycle=rows.filter(r=>normName(r.mitarbeiter)!=="BESETZT");
      if(this.cycle.length===0) throw new Error("Alle Einträge sind BESETZT – kein Rotationszyklus möglich.");

      this.startIndex=new Map();
      this.cycle.forEach((r,i)=>{
        const key=normName(r.mitarbeiter);
        if(!this.startIndex.has(key)) this.startIndex.set(key,i);
      });
    }
    assignment(employee, dayKey, roundNo){
      if(roundNo<1 || roundNo>this.roundsPerDay) throw new Error(`Runde muss 1-${this.roundsPerDay} sein.`);
      const empKey=normName(employee);
      if(!this.startIndex.has(empKey)) throw new Error(`Mitarbeiter '${employee}' nicht im Plan gefunden.`);
      const d=DAY_ALIASES[dayKey];
      const steps=d*this.roundsPerDay + (roundNo-1);
      const start=this.startIndex.get(empKey);
      const pos=(start+steps)%this.cycle.length;
      return this.cycle[pos];
    }
    weeklyOverview(employee, days=5){
      const out=[];
      for(let d=0; d<days; d++){
        const dayKey = DAY_KEYS[d];
        for(let r=1; r<=this.roundsPerDay; r++){
          const row=this.assignment(employee, dayKey, r);
          out.push({ tag: DAY_NAMES[d], runde: r, station: row.bezeichnung, takt: row.takt });
        }
      }
      return out;
    }
  }

  function diagnostics(rows){
    const takts=rows.map(r=>r.takt);
    const uniq=new Set(takts);
    const dups=takts.filter((t,idx)=>takts.indexOf(t)!==idx);
    const min=Math.min(...takts);
    const max=Math.max(...takts);
    const missing=[];
    for(let t=min; t<=max; t++){ if(!uniq.has(t)) missing.push(t); }
    return { count: rows.length, uniq: uniq.size, min, max, dups: Array.from(new Set(dups)), missing };
  }

  // ---------- "Heute / Jetzt" logic (fixed schedule, exact :30/:45 starts) ----------
  function toMin(hh, mm){ return hh*60 + mm; }
  function timeMinNow(){
    const n = new Date();
    return toMin(n.getHours(), n.getMinutes());
  }
  function inRangeHalfOpen(t, start, end){
    return t >= start && t < end; // [start, end)
  }

  function computeDayKeyNow(){
    const now = new Date();
    const js = now.getDay();          // 0=Sun..6=Sat
    const dayIndex = (js + 6) % 7;    // Mon=0..Sun=6
    return { dayIndex, dayKey: DAY_KEYS[dayIndex], dayName: DAY_NAMES[dayIndex] };
  }

  function detectShift(){
    const t = timeMinNow();
    const inEarly = inRangeHalfOpen(t, toMin(6,30), toMin(14,30));
    const inLate  = inRangeHalfOpen(t, toMin(14,30), toMin(22,30));
    const inNight = inRangeHalfOpen(t, toMin(22,30), toMin(24,0)) || inRangeHalfOpen(t, toMin(0,0), toMin(6,11));
    if(inEarly) return "early";
    if(inLate)  return "late";
    if(inNight) return "night";
    return elShift.value || "early";
  }

  function currentRoundByShift(shift){
    const t = timeMinNow();
    const breakPolicy = "next"; // per your request

    let schedule = [];

    if(shift === "early"){
      schedule = [
        { kind:"work",  start: toMin(6,30),  end: toMin(8,15),  round:1 },
        { kind:"break", start: toMin(8,15),  end: toMin(8,30),  next:2, last:1 },
        { kind:"work",  start: toMin(8,30),  end: toMin(10,15), round:2 },
        { kind:"break", start: toMin(10,15), end: toMin(10,45), next:3, last:2 },
        { kind:"work",  start: toMin(10,45), end: toMin(12,30), round:3 },
        { kind:"break", start: toMin(12,30), end: toMin(12,45), next:4, last:3 },
        { kind:"work",  start: toMin(12,45), end: toMin(14,30), round:4 },
      ];
    }

    if(shift === "late"){
      schedule = [
        { kind:"work",  start: toMin(14,30), end: toMin(16,15), round:1 },
        { kind:"break", start: toMin(16,15), end: toMin(16,30), next:2, last:1 },
        { kind:"work",  start: toMin(16,30), end: toMin(18,15), round:2 },
        { kind:"break", start: toMin(18,15), end: toMin(18,45), next:3, last:2 },
        { kind:"work",  start: toMin(18,45), end: toMin(20,30), round:3 },
        { kind:"break", start: toMin(20,30), end: toMin(20,45), next:4, last:3 },
        { kind:"work",  start: toMin(20,45), end: toMin(22,30), round:4 },
      ];
    }

    if(shift === "night"){
      schedule = [
        { kind:"work",  start: toMin(22,30), end: toMin(24,0),  round:1 },
        { kind:"work",  start: toMin(0,0),   end: toMin(0,15),  round:1 },
        { kind:"break", start: toMin(0,15),  end: toMin(0,30),  next:2, last:1 },
        { kind:"work",  start: toMin(0,30),  end: toMin(2,15),  round:2 },
        { kind:"break", start: toMin(2,15),  end: toMin(2,45),  next:3, last:2 },
        { kind:"work",  start: toMin(2,45),  end: toMin(4,30),  round:3 },
        { kind:"break", start: toMin(4,30),  end: toMin(4,45),  next:4, last:3 },
        { kind:"work",  start: toMin(4,45),  end: toMin(6,11),  round:4 },
      ];
    }

    for(const e of schedule){
      if(inRangeHalfOpen(t, e.start, e.end)){
        if(e.kind === "work"){
          return { kind:"work", round:e.round, label:`Runde ${e.round}` };
        }
        if(e.kind === "break"){
          const r = (breakPolicy === "next") ? e.next : e.last;
          return { kind:"break", round:r, label:`Pause (setzt nächste Runde: ${r})` };
        }
      }
    }

    return { kind:"out", round:null, label:"Außerhalb Schichtzeit" };
  }

  function setTodayAndNow(){
    const shift = detectShift();
    elShift.value = shift;

    const info = currentRoundByShift(shift);

    // Tag bestimmen – bei Nachtschicht nach 00:00 gehört es zum Vortag
    let { dayIndex, dayKey, dayName } = computeDayKeyNow();
    const t = timeMinNow();
    const nightAfterMidnight = (shift === "night") && (t < toMin(6,11)); // 00:00–06:10

    if(nightAfterMidnight){
      dayIndex = (dayIndex + 6) % 7; // -1 mod 7
      dayKey = DAY_KEYS[dayIndex];
      dayName = DAY_NAMES[dayIndex];
    }

    elDay.value = dayKey;
    if(info.round) elRound.value = String(info.round);

    const shiftName = (shift==="early") ? "Früh" : (shift==="late" ? "Spät" : "Nacht");
    nowHint.textContent = `Heute: ${dayName} • Schicht: ${shiftName} • ${info.label}`;

    // Auto-refresh current view without buzzing
    if(currentView==="compare") runCompare(true);
    else if(currentView==="single") runSingle(true);

    saveLastQuery();
  }

  // ---------- favorites ----------
  function loadFavs(){ return loadJSON(FAV_KEY, []); }
  function saveFavs(favs){ saveJSON(FAV_KEY, favs); }

  function renderFavbar(){
    const favs = loadFavs();
    favbar.innerHTML = "";
    if(!favs.length) return;

    favs.forEach(name=>{
      const btn=document.createElement("button");
      btn.type="button";
      btn.textContent=name;
      btn.addEventListener("click", ()=>{
        haptic("tap");
        const target = Array.from(elEmp.options).find(o => normName(o.value)===normName(name));
        if(target){
          elEmp.value = target.value;
          hideWeek();
          hideDay();
          maybeAutoUpdate();
          saveLastQuery();
        }
      });
      favbar.appendChild(btn);
    });
  }

  function editFavs(){
    const current = loadFavs().join(", ");
    const input = prompt("Favoriten (kommagetrennt), z.B. LOUIS, FLORIAN, JUSTIN", current);
    if(input===null) return;
    const favs = input.split(",").map(s=>s.trim()).filter(Boolean);
    saveFavs(favs);
    renderFavbar();
  }

  // ---------- UI elements ----------
  const elPlanSelect = document.getElementById("planSelect");
  const elLoadSaved = document.getElementById("loadSaved");
  const elDeleteSaved = document.getElementById("deleteSaved");

  const elTable = document.getElementById("table");
  const elRounds = document.getElementById("rounds");
  const elAutoApply = document.getElementById("autoApply");
  const elAutoSave = document.getElementById("autoSave");
  const elApplyBtn = document.getElementById("applyBtn");
  const elShift = document.getElementById("shiftPreset");

  const elEmp = document.getElementById("employee");
  const elEmp2 = document.getElementById("employee2");

  const elDay = document.getElementById("day");
  const elRound = document.getElementById("round");
  const elQuery = document.getElementById("queryBtn");
  const elCompare = document.getElementById("compareBtn");
  const elWeekBtn = document.getElementById("weekBtn");
  const elSwap = document.getElementById("swapBtn");
  const elClear = document.getElementById("clearBtn");

  const elDayBtn = document.getElementById("dayBtn");
  const elDayView = document.getElementById("dayView");

  const elResult = document.getElementById("result");
  const elWeek = document.getElementById("week");
  const elPlanName = document.getElementById("planName");
  const elSaveNew = document.getElementById("saveNew");
  const elOverwriteActive = document.getElementById("overwriteActive");

  const diagPills = document.getElementById("diagPills");
  const nowBtn = document.getElementById("nowBtn");
  const nowHint = document.getElementById("nowHint");
  const editFavBtn = document.getElementById("editFavBtn");
  const favbar = document.getElementById("favbar");

  const themeAuto = document.getElementById("themeAuto");
  const themeDark = document.getElementById("themeDark");
  const themeLight = document.getElementById("themeLight");
  const modeFull = document.getElementById("modeFull");
  const modeCompact = document.getElementById("modeCompact");
  const haptOn = document.getElementById("haptOn");
  const haptOff = document.getElementById("haptOff");

  let plan = null;
  let applyTimer = null;

  // view state: "single" | "compare"
  let currentView = "single";

  function setView(v){
    currentView = v;
    saveLastQuery();
  }

  function refreshPlanSelect(){
    const state = loadState();
    const entries = Object.entries(state.plans)
      .map(([id,p])=>({id, ...p}))
      .sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||""));

    elPlanSelect.innerHTML="";
    const opt0=document.createElement("option");
    opt0.value=""; opt0.textContent="— keinen auswählen —";
    elPlanSelect.appendChild(opt0);

    for(const p of entries){
      const opt=document.createElement("option");
      opt.value=p.id;
      const stamp = p.updatedAt ? p.updatedAt.slice(0,16).replace("T"," ") : "";
      opt.textContent=`${p.name} (${stamp})`;
      elPlanSelect.appendChild(opt);
    }
    elPlanSelect.value = state.activeId || "";
  }

  function renderDiagnostics(diag, roundsPerDay){
    const state = loadState();
    const active = state.activeId ? "Aktiv-Plan: JA" : "Aktiv-Plan: NEIN";
    const warn = [];
    if(diag.dups.length) warn.push(`Doppelt: ${diag.dups.join(", ")}`);
    if(diag.missing.length) warn.push(`Fehlt: ${diag.missing.join(", ")}`);

    const pills = [];
    pills.push(`<span class="pill">Erkannt: <strong>${diag.count}</strong></span>`);
    pills.push(`<span class="pill">Zyklus: <strong>${plan ? plan.cycle.length : "-"}</strong></span>`);
    pills.push(`<span class="pill">Runden/Tag: <strong>${roundsPerDay}</strong></span>`);
    pills.push(`<span class="pill">${active}</span>`);
    if(warn.length) pills.push(`<span class="pill">Hinweis: <strong>${warn.join(" • ")}</strong></span>`);

    diagPills.innerHTML = pills.join("");
  }

  function applyPlan({silent=false} = {}){
    const text = elTable.value;
    const rpd = parseInt(elRounds.value,10) || 4;
    hideDay();
    hideWeek();

    const rows = parseTable(text);
    const diag = diagnostics(rows);

    plan = new TaktPlan(rows, rpd);

    const names = Array.from(new Set(plan.cycle.map(r=>r.mitarbeiter.trim())))
      .sort((a,b)=>normName(a).localeCompare(normName(b)));

    elEmp.innerHTML="";
    elEmp2.innerHTML="";
    for(const name of names){
      const optA=document.createElement("option");
      optA.value=name; optA.textContent=name;
      elEmp.appendChild(optA);

      const optB=document.createElement("option");
      optB.value=name; optB.textContent=name;
      elEmp2.appendChild(optB);
    }

    fillRounds(rpd);
    setEnabled(true);

    const last = loadLastQuery();
    if(last){
      const targetA = names.find(n=>normName(n)===normName(last.employee));
      const targetB = names.find(n=>normName(n)===normName(last.employee2));
      if(targetA) elEmp.value = targetA;
      if(targetB) elEmp2.value = targetB;
      if(last.day) elDay.value = last.day;
      if(last.round) elRound.value = last.round;
      if(last.view) currentView = last.view;
    }

    if(elEmp2.options.length > 1 && normName(elEmp2.value) === normName(elEmp.value)){
      const aIdx = elEmp.selectedIndex >= 0 ? elEmp.selectedIndex : 0;
      const bIdx = (aIdx + 1) % elEmp2.options.length;
      elEmp2.selectedIndex = bIdx;
    }

    // Auto-save active plan after successful apply
    const state = loadState();
    const activeId = state.activeId;
    if(elAutoSave.value==="on" && activeId && state.plans[activeId]){
      state.plans[activeId] = { ...state.plans[activeId], text, rounds: rpd, updatedAt: nowISO() };
      saveState(state);
      refreshPlanSelect();
    }

    renderFavbar();
    renderDiagnostics(diag, rpd);

    if(currentView === "compare") runCompare(true);
    else if(currentView === "single") runSingle(true);

    if(!silent){
      showOk(`Plan angewendet. Du kannst jetzt abfragen, vergleichen oder „Heute/Jetzt“ nutzen.`, true);
    }
  }

  function scheduleAutoApply(){
    if(elAutoApply.value!=="on") return;
    if(applyTimer) clearTimeout(applyTimer);
    applyTimer = setTimeout(()=>{
      try{
        if(!elTable.value.trim()) return;
        applyPlan({silent:true});
      } catch(e){
        // silent on auto-apply
      }
    }, 600);
  }

  // ---------- compare ----------
  function runSingle(auto=false){
    if(!plan) throw new Error("Bitte erst Plan anwenden (oder Auto-Apply nutzen).");

    const employee = elEmp.value;
    const dayKey = elDay.value;
    const roundNo = parseInt(elRound.value,10);

    const row = plan.assignment(employee, dayKey, roundNo);
    const dayName = DAY_NAMES[DAY_ALIASES[dayKey]];

    hideWeek();
    hideDay();

    showOk(`
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="pill"><strong>${employee}</strong></span>
        <span class="pill">${dayName}</span>
        <span class="pill">Runde <strong>${roundNo}</strong></span>
        ${auto ? `<span class="pill">Auto</span>` : ``}
      </div>
      <div style="font-size:22px; font-weight:900; margin-top:10px;">${row.bezeichnung}</div>
      <div class="mono" style="margin-top:8px; color: var(--muted);">Takt ${row.takt}</div>
    `, !auto);
  }

  function runCompare(auto=false){
    if(!plan) throw new Error("Bitte erst Plan anwenden (oder Auto-Apply nutzen).");

    const employeeA = elEmp.value;
    const employeeB = elEmp2.value;
    const dayKey = elDay.value;
    const roundNo = parseInt(elRound.value,10);

    const rowA = plan.assignment(employeeA, dayKey, roundNo);
    const rowB = plan.assignment(employeeB, dayKey, roundNo);
    const dayName = DAY_NAMES[DAY_ALIASES[dayKey]];

    hideWeek();

    const same = (normName(rowA.bezeichnung) === normName(rowB.bezeichnung)) && (rowA.takt === rowB.takt);

    showOk(`
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <span class="pill">${dayName}</span>
        <span class="pill">Runde <strong>${roundNo}</strong></span>
        ${same ? `<span class="pill"><strong>Gleich</strong></span>` : `<span class="pill">Unterschied</span>`}
        ${auto ? `<span class="pill">Auto</span>` : ``}
      </div>

      <div style="margin-top:12px; display:grid; gap:10px;">
        <div style="padding:12px; border:1px solid var(--border); border-radius:14px; background: var(--card);">
          <div style="font-weight:900; margin-bottom:6px;">${employeeA}</div>
          <div style="font-size:20px; font-weight:900;">${rowA.bezeichnung}</div>
          <div class="mono" style="margin-top:6px; color: var(--muted);">Takt ${rowA.takt}</div>
        </div>

        <div style="padding:12px; border:1px solid var(--border); border-radius:14px; background: var(--card);">
          <div style="font-weight:900; margin-bottom:6px;">${employeeB}</div>
          <div style="font-size:20px; font-weight:900;">${rowB.bezeichnung}</div>
          <div class="mono" style="margin-top:6px; color: var(--muted);">Takt ${rowB.takt}</div>
        </div>
      </div>
    `, !auto);
  }

  function maybeAutoUpdate(){
    if(!plan) return;
    try{
      if(currentView==="compare") runCompare(true);
      else runSingle(true);
    } catch(e){
      // ignore on auto-update
    }
  }

  // ---------- plan save/load ----------
  function saveNewPlan(){
    const name=(elPlanName.value||"").trim();
    if(!name) throw new Error("Bitte einen Namen eingeben (z.B. 'Standardwoche').");
    const text=elTable.value;
    const rounds=parseInt(elRounds.value,10) || 4;
    if(!text.trim()) throw new Error("Plan-Text ist leer.");

    const rows=parseTable(text);
    new TaktPlan(rows, rounds);

    const state=loadState();
    const id=uid();
    state.plans[id]={ name, text, rounds, updatedAt: nowISO() };
    state.activeId=id;
    saveState(state);
    refreshPlanSelect();
  }

  function overwriteActivePlan(){
    const state=loadState();
    const id=state.activeId;
    if(!id || !state.plans[id]) throw new Error("Kein aktiver Plan ausgewählt.");
    const text=elTable.value;
    const rounds=parseInt(elRounds.value,10) || 4;
    if(!text.trim()) throw new Error("Plan-Text ist leer.");

    const rows=parseTable(text);
    new TaktPlan(rows, rounds);

    state.plans[id]={ ...state.plans[id], text, rounds, updatedAt: nowISO() };
    saveState(state);
    refreshPlanSelect();
  }

  function loadSelectedPlan(){
    const state=loadState();
    const id=elPlanSelect.value;
    if(!id || !state.plans[id]) throw new Error("Kein gespeicherter Plan ausgewählt.");
    const p=state.plans[id];

    elTable.value=p.text || "";
    elRounds.value=p.rounds || 4;
    saveDraft();

    state.activeId=id;
    saveState(state);
    refreshPlanSelect();

    applyPlan({silent:false});
    showOk(`Plan geladen & angewendet: <strong>${p.name}</strong>`, true);
  }

  function deleteSelectedPlan(){
    const state=loadState();
    const id=elPlanSelect.value;
    if(!id || !state.plans[id]) throw new Error("Kein gespeicherter Plan ausgewählt.");
    const name=state.plans[id].name || id;

    delete state.plans[id];
    if(state.activeId===id) state.activeId=null;
    saveState(state);
    refreshPlanSelect();

    showOk(`Plan gelöscht: <strong>${name}</strong>`, true);
  }

  // ---------- week view ----------
  function showDay(employee, dayKey){
    if(!plan) throw new Error("Bitte erst Plan anwenden (oder Auto-Apply nutzen).");

    const dIdx = DAY_ALIASES[dayKey];
    const dayName = DAY_NAMES[dIdx];

    const data = [];
    for(let r=1; r<=plan.roundsPerDay; r++){
      const row = plan.assignment(employee, dayKey, r);
      data.push({ runde:r, station: row.bezeichnung, takt: row.takt });
    }

    elDayView.classList.remove("hide");
    elDayView.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:900;">Tagesüberblick: ${employee}</div>
        <div class="small">${dayName} • Runden: ${plan.roundsPerDay}</div>
      </div>
      <table>
        <thead><tr><th>R</th><th>Station</th><th>Takt</th></tr></thead>
        <tbody>
          ${data.map(r=>`<tr><td>${r.runde}</td><td>${r.station}</td><td class="mono">${r.takt}</td></tr>`).join("")}
        </tbody>
      </table>
    `;
  }

  function showWeek(employee){
    if(!plan) throw new Error("Bitte erst Plan anwenden (oder Auto-Apply nutzen).");

    const data = plan.weeklyOverview(employee, 5);

    elWeek.classList.remove("hide");
    elWeek.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div style="font-weight:900;">Wochenübersicht (Mo–Fr): ${employee}</div>
        <div class="small">Runden/Tag: ${plan.roundsPerDay}</div>
      </div>
      <table>
        <thead><tr><th>Tag</th><th>R</th><th>Station</th><th>Takt</th></tr></thead>
        <tbody>
          ${data.map(r=>`<tr><td>${r.tag}</td><td>${r.runde}</td><td>${r.station}</td><td class="mono">${r.takt}</td></tr>`).join("")}
        </tbody>
      </table>
    `;
  }

  // ---------- init ----------
  (function init(){
    const ui = loadJSON(UI_KEY, { theme:"auto", mode:"full", haptics:"on" });
    setTheme(ui.theme || "auto");
    setMode(ui.mode || "full");
    setHaptics(ui.haptics || "on");

    const draft = loadDraft();
    if(draft){
      if(draft.text) elTable.value = draft.text;
      if(draft.rounds) elRounds.value = draft.rounds;
      if(draft.autoApply) elAutoApply.value = draft.autoApply;
      if(draft.autoSave) elAutoSave.value = draft.autoSave;
      if(draft.shiftPreset) elShift.value = draft.shiftPreset;
    }

    const last = loadLastQuery();
    if(last && last.view) currentView = last.view;

    refreshPlanSelect();
    setEnabled(false);
    renderFavbar();

    const detected = detectShift();
    const shiftName = detected==="early" ? "Früh" : (detected==="late" ? "Spät" : "Nacht");
    nowHint.textContent = `Schicht-Erkennung: ${shiftName}. Tippe „Heute/Jetzt“, um Tag + Runde zu setzen.`;
  })();

  // ---------- events ----------
  themeAuto.addEventListener("click", ()=>{ setTheme("auto"); haptic("tap"); });
  themeDark.addEventListener("click", ()=>{ setTheme("dark"); haptic("tap"); });
  themeLight.addEventListener("click", ()=>{ setTheme("light"); haptic("tap"); });

  modeFull.addEventListener("click", ()=>{ setMode("full"); haptic("tap"); });
  modeCompact.addEventListener("click", ()=>{ setMode("compact"); haptic("tap"); });

  haptOn.addEventListener("click", ()=>{ setHaptics("on"); haptic("tap"); });
  haptOff.addEventListener("click", ()=>{ setHaptics("off"); });

  elTable.addEventListener("input", ()=>{ saveDraft(); scheduleAutoApply(); });
  [elRounds, elAutoApply, elAutoSave, elShift].forEach(el=>{
    el.addEventListener("input", ()=>{ saveDraft(); scheduleAutoApply(); });
    el.addEventListener("change", ()=>{ saveDraft(); scheduleAutoApply(); });
  });

  elApplyBtn.addEventListener("click", ()=>{
    try{
      haptic("tap");
      applyPlan({silent:false});
    } catch(e){
      plan=null;
      setEnabled(false);
      showErr(e.message || String(e), true);
    }
  });

  nowBtn.addEventListener("click", ()=>{
    try{
      haptic("tap");
      setTodayAndNow();
      showOk("Heute/Jetzt gesetzt. Tag und Runde sind vorausgewählt.", true);
    } catch(e){
      showErr(e.message || String(e), true);
    }
  });

  elQuery.addEventListener("click", ()=>{
    try{
      haptic("tap");
      setView("single");
      runSingle(false);
      saveLastQuery();
    } catch(e){
      showErr(e.message || String(e), true);
    }
  });

  elCompare.addEventListener("click", ()=>{
    try{
      haptic("tap");
      setView("compare");
      runCompare(false);
      saveLastQuery();
    } catch(e){
      showErr(e.message || String(e), true);
    }
  });

  elDayBtn.addEventListener("click", ()=>{
  try{
    haptic("tap");
    setView("single");
    hideWeek();
    const employee = elEmp.value;
    const dayKey = elDay.value;
    showDay(employee, dayKey);
    saveLastQuery();
  } catch(e){
    showErr(e.message || String(e), true);
  }
});

  elSwap.addEventListener("click", ()=>{
  try{
    haptic("tap");
    const a = elEmp.value;
    const b = elEmp2.value;
    elEmp.value = b;
    elEmp2.value = a;

    // Falls eine Übersicht offen ist: neu rendern
    const dayOpen = !elDayView.classList.contains("hide");
    const weekOpen = !elWeek.classList.contains("hide");

    if(weekOpen){
      hideDay();
      showWeek(elEmp.value);
    } else if(dayOpen){
      hideWeek();
      showDay(elEmp.value, elDay.value);
    } else {
      hideWeek();
      hideDay();
      maybeAutoUpdate();
    }

    saveLastQuery();
    showOk("Mitarbeiter A und B getauscht.", true);
  } catch(e){
    showErr(e.message || String(e), true);
  }
});

  elWeekBtn.addEventListener("click", ()=>{
    try{
      haptic("tap");
      setView("single");
      const employee = elEmp.value;
      showWeek(employee);
      saveLastQuery();
    } catch(e){
      showErr(e.message || String(e), true);
    }
  });

  elClear.addEventListener("click", ()=>{
    haptic("tap");
    elTable.value="";
    saveDraft();
    plan=null;
    setEnabled(false);
    hideWeek();
    hideDay();
    diagPills.innerHTML="";
    showOk("Eingabe geleert.", true);
  });

  editFavBtn.addEventListener("click", ()=>{ haptic("tap"); editFavs(); });

  elSaveNew.addEventListener("click", ()=>{
    try{
      haptic("tap");
      saveNewPlan();
      const st = loadState();
      showOk(`Gespeichert und aktiviert: <strong>${st.plans[st.activeId].name}</strong>`, true);
    } catch(e){
      showErr(e.message || String(e), true);
    }
  });

  elOverwriteActive.addEventListener("click", ()=>{
    try{
      haptic("tap");
      overwriteActivePlan();
      showOk(`Aktiver Plan überschrieben.`, true);
    } catch(e){
      showErr(e.message || String(e), true);
    }
  });

  elLoadSaved.addEventListener("click", ()=>{
    try{
      haptic("tap");
      loadSelectedPlan();
    } catch(e){
      showErr(e.message || String(e), true);
    }
  });

  elDeleteSaved.addEventListener("click", ()=>{
    try{
      haptic("tap");
      deleteSelectedPlan();
    } catch(e){
      showErr(e.message || String(e), true);
    }
  });

  // Auto-update hooks
  [elEmp, elEmp2, elDay, elRound].forEach(el=>{
    el.addEventListener("change", ()=>{
      saveLastQuery();
      maybeAutoUpdate();
    });
  });
</script>
</body>
</html>


